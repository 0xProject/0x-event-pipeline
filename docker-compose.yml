version: '3'
services:
    postgres:
        image: postgres:10.14
        environment:
            - POSTGRES_USER=api
            - POSTGRES_PASSWORD=api
            - POSTGRES_DB=events
            - POSTGRES_PORT=5432
        # persist the postgres data to disk so we don't lose it
        # on rebuilds.
        volumes:
            - ./postgres:/var/lib/postgresql/data
        ports:
            - '5432:5432'
        command: ["postgres", "-c", "log_statement=all", "-c", "log_destination=stderr"]
    event-pipeline-ethereum:
        depends_on:
            - postgres
        build:
            context: event-pipeline-evm
        restart: always
        environment:
            ETHEREUM_RPC_URL: '${ETHEREUM_RPC_URL}'
            CHAIN_ID: '1'
            POSTGRES_URI: 'postgres://api:api@postgres/events'
            SCHEMA: 'events'
            EP_DEPLOYMENT_BLOCK: 10247094
            MAX_BLOCKS_TO_SEARCH: 1000
            MAX_BLOCKS_TO_PULL: 1000
            MAX_TX_TO_PULL: 1000
            MINUTES_BETWEEN_RUNS: 1
            FEAT_UNISWAP_V2_VIP_SWAP_EVENT: "true"
            UNISWAP_V2_VIP_SWAP_SOURCES: "UniswapV2,SushiSwap"
            UNISWAP_V2_VIP_SWAP_START_BLOCK: 10917104
            FEAT_UNISWAP_V3_VIP_SWAP_EVENT: "true"
            UNISWAP_V3_VIP_SWAP_START_BLOCK: 12553659
            FEAT_LIMIT_ORDERS: "true"
            V4_NATIVE_FILL_START_BLOCK: "11591021"
            FEAT_PLP_SWAP_EVENT: "true"
            PLP_VIP_START_BLOCK: 11377457
            FEAT_OTC_ORDERS: "true"
            OTC_ORDERS_FEATURE_START_BLOCK: 13143075
            FEAT_CANCEL_EVENTS: "true"
            FEAT_STAKING: "true"
            STAKING_DEPLOYMENT_BLOCK: 8952581
            FEAT_RFQ_EVENT: "true"
            FEAT_V3_NATIVE_FILL: "true"
            FEAT_ERC20_BRIDGE_TRANSFER_FLASHWALLET: "true"
            FLASHWALLET_ADDRESS: "0x22f9dcf4647084d6c31b2765f6910cd85c178c18"
            FLASHWALLET_DEPLOYMENT_BLOCK: 12231666

    event-pipeline-bsc:
        depends_on:
            - postgres
        build:
            context: event-pipeline-evm
        restart: always
        environment:
            ETHEREUM_RPC_URL: '${ETHEREUM_RPC_URL_BSC}'
            CHAIN_ID: '56'
            POSTGRES_URI: 'postgres://api:api@postgres/events'
            SCHEMA: 'events_bsc'
            EP_DEPLOYMENT_BLOCK: 5375047
            MAX_BLOCKS_TO_SEARCH: 2000
            MAX_BLOCKS_TO_PULL: 5000
            MINUTES_BETWEEN_RUNS: 1
            FEAT_UNISWAP_V2_VIP_SWAP_EVENT: "true"
            UNISWAP_V2_VIP_SWAP_SOURCES: "PancakeSwap,BakerySwap,SushiSwap"
            FEAT_ONEINCH_SWAPPED_V3_EVENT: "true"
            ONEINCH_ROUTER_V3_DEPLOYMENT_BLOCK: 5300000
            FEAT_ONEINCH_SWAPPED_V4_EVENT: "true"
            ONEINCH_ROUTER_V4_DEPLOYMENT_BLOCK: 12386039

    event-pipeline-polygon:
        depends_on:
            - postgres
        build:
            context: event-pipeline-evm
            dockerfile: Dockerfile.dev
        restart: always
        environment:
            ETHEREUM_RPC_URL: '${ETHEREUM_RPC_URL_POLYGON}'
            CHAIN_ID: '137'
            POSTGRES_URI: 'postgres://api:api@postgres/events'
            SCHEMA: 'events_polygon'
            ENABLE_PROMETHEUS_METRICS: "true"
            EP_DEPLOYMENT_BLOCK: 14391480
            MAX_BLOCKS_TO_SEARCH: 2000
            MAX_BLOCKS_TO_PULL: 2000
            MINUTES_BETWEEN_RUNS: 1
            FEAT_ONEINCH_SWAPPED_V3_EVENT: "true"
            ONEINCH_ROUTER_V3_DEPLOYMENT_BLOCK: 14500000
            FEAT_ONEINCH_SWAPPED_V4_EVENT: "true"
            ONEINCH_ROUTER_V4_DEPLOYMENT_BLOCK: 21008423
            FEAT_SLINGSHOT_TRADE_EVENT: "true"
            SLINGSHOT_DEPLOYMENT_BLOCK: 14500000
            FEAT_PARASWAP_SWAPPED_EVENT: "true"
            PARASWAP_DEPLOYMENT_BLOCK: 14500000
            PARASWAP_CONTRACT_ADDRESS: "0x90249ed4d69D70E709fFCd8beE2c5A566f65dADE"
            FEAT_LIMIT_ORDERS: "true"
            V4_NATIVE_FILL_START_BLOCK: "22788948"


    event-pipeline-avalanche:
        depends_on:
            - postgres
        build:
            context: event-pipeline-evm
            dockerfile: Dockerfile.dev
        restart: always
        environment:
            ETHEREUM_RPC_URL: '${ETHEREUM_RPC_URL_AVALANCHE}'
            CHAIN_ID: '43114'
            POSTGRES_URI: 'postgres://api:api@postgres/events'
            SCHEMA: 'events_avalanche'
            ENABLE_PROMETHEUS_METRICS: "true"
            EP_DEPLOYMENT_BLOCK: 3601700
            MAX_BLOCKS_TO_SEARCH: 5000
            MAX_BLOCKS_TO_PULL: 2000
            MINUTES_BETWEEN_RUNS: 1

    event-pipeline-optimism:
        depends_on:
            - postgres
        build:
            context: event-pipeline-evm
            dockerfile: Dockerfile.dev
        restart: always
        environment:
            ETHEREUM_RPC_URL: '${ETHEREUM_RPC_URL_OPTIMISM}'
            CHAIN_ID: '10'
            POSTGRES_URI: 'postgres://api:api@postgres/events'
            SCHEMA: 'events_optimism'
            EP_DEPLOYMENT_BLOCK: 1691335
            MAX_BLOCKS_TO_SEARCH: 1000
            MAX_BLOCKS_TO_PULL: 1000
            SECONDS_BETWEEN_RUNS: 30
            EP_ADDRESS: "0xDEF1ABE32c034e558Cdd535791643C58a13aCC10"
            # FEAT_ONEINCH_SWAPPED_EVENT: "true"
            # ONEINCH_ROUTER_V3_DEPLOYMENT_BLOCK: 14500000
            # FEAT_SLINGSHOT_TRADE_EVENT: "true"
            # SLINGSHOT_DEPLOYMENT_BLOCK: 14500000
            # FEAT_PARASWAP_SWAPPED_EVENT: "true"
            # PARASWAP_DEPLOYMENT_BLOCK: 14500000
            # PARASWAP_CONTRACT_ADDRESS: "0x90249ed4d69D70E709fFCd8beE2c5A566f65dADE"

    event-pipeline-ropsten:
        depends_on:
            - postgres
        build:
            context: event-pipeline-evm
            dockerfile: Dockerfile.dev
        restart: always
        environment:
            ETHEREUM_RPC_URL: '${ETHEREUM_RPC_URL_ROPSTEN}'
            CHAIN_ID: '3'
            POSTGRES_URI: 'postgres://api:api@postgres/events'
            SCHEMA: 'events_ropsten'
            EP_DEPLOYMENT_BLOCK: 8075130
            MAX_BLOCKS_TO_SEARCH: 1000
            MAX_BLOCKS_TO_PULL: 1000
            FEAT_RFQ_EVENT: "true"
            FEAT_LIMIT_ORDERS: "true"
            V4_NATIVE_FILL_START_BLOCK: 10125228
            FEAT_OTC_ORDERS: "true"
            OTC_ORDERS_FEATURE_START_BLOCK: 10857214
            FEAT_NFT: "true"
            NFT_FEATURE_START_BLOCK: 11849825


    staking-api:
        depends_on:
            - event-pipeline-ethereum
        build:
            context: .
            dockerfile: staking-api/Dockerfile
        restart: always
        environment:
            POSTGRES_URI: 'postgres://api:api@postgres/events'
        ports:
            - '4000:4000'
